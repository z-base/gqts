openapi: 3.1.2
info:
  title: GQTS Core API
  version: 1.0.0-draft
  summary: OpenAPI normative surface for GQTS Core discovery and linear signed-token replication.
  description: |
    This OpenAPI file is the normative endpoint contract for GQTS Core.

    Semantics:
    - GET operations are synchronous retrieval operations.
    - POST ingest/gossip operations are logically asynchronous and return 202 Accepted.
    - Integrity acceptance is based on proof/signature verification over canonicalized token content.
    - Standalone content-hash fields are not acceptance inputs and MUST be ignored.

    Versioning strategy:
    - Major/minor profile semantics are encoded in `info.version` and media types.
    - Backward-incompatible changes require a new API version and explicit migration text.
  license:
    name: MIT
    url: https://opensource.org/license/mit
  x-document-authority:
    status: editor-draft
    note: Not an adopted ETSI deliverable and not a W3C Recommendation.
  x-media-type-policy:
    baseline: RFC6838
    strategy: Use +json structured syntax suffix and profile-versioned compatibility policy.
    registrationStatus: pending-specification-review

servers:
  - url: https://example.org
    description: Example origin

security: []

x-gqts-requirements:
  REQ-GQTS-01: Governance-scoped scheme discovery.
  REQ-GQTS-02: Endpoint-kind taxonomy publication.
  REQ-GQTS-03: Service descriptor active token-chain state publication.
  REQ-GQTS-04: Low-cost head-token synchronization and merge-reconciliation metadata publication.
  REQ-GQTS-05: Append-only linear token-chain retrieval.
  REQ-GQTS-06: Asynchronous ingest and receipt model.
  REQ-GQTS-07: Immutable token addressing.

tags:
  - name: scheme
    description: Governance-scoped scheme metadata.
  - name: type
    description: Trust-service instance metadata and current token-chain head state.
  - name: event
    description: Append-only linear signed-token log retrieval and ingest.

paths:
  /.well-known/gidas/gqts/scheme/{governanceCode}:
    get:
      tags: [scheme]
      operationId: getSchemeDescriptor
      summary: Get scheme descriptor.
      x-gqts-requirement: REQ-GQTS-01
      description: |
        Returns governance-scoped naming, canonicalization, proof profile, and publication-floor metadata.
      parameters:
        - $ref: '#/components/parameters/GovernanceCode'
        - $ref: '#/components/parameters/IfNoneMatch'
      responses:
        '200':
          description: Scheme descriptor.
          headers:
            ETag:
              $ref: '#/components/headers/EntityTag'
            Cache-Control:
              $ref: '#/components/headers/CacheControl'
          content:
            application/gqts.scheme+json:
              schema:
                $ref: '#/components/schemas/SchemeDescriptor'
            application/json:
              schema:
                $ref: '#/components/schemas/SchemeDescriptor'
        '304':
          description: Not modified.
        '400':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqts/scheme/{governanceCode}/endpoint-kinds:
    get:
      tags: [scheme]
      operationId: getEndpointKindCatalog
      summary: Get endpoint-kind catalog.
      x-gqts-requirement: REQ-GQTS-02
      description: |
        Returns the normative endpoint-kind mapping (`scheme`, `type`, `event`) for a governance profile.
        This operation provides machine-readable requirement-level conformance metadata.
      parameters:
        - $ref: '#/components/parameters/GovernanceCode'
        - $ref: '#/components/parameters/IfNoneMatch'
      responses:
        '200':
          description: Endpoint-kind catalog.
          headers:
            ETag:
              $ref: '#/components/headers/EntityTag'
            Cache-Control:
              $ref: '#/components/headers/CacheControl'
          content:
            application/gqts.endpoint-kinds+json:
              schema:
                $ref: '#/components/schemas/EndpointKindCatalog'
            application/json:
              schema:
                $ref: '#/components/schemas/EndpointKindCatalog'
        '304':
          description: Not modified.
        '400':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqts/type/{serviceId}:
    get:
      tags: [type]
      operationId: getTypeDescriptor
      summary: Get service descriptor.
      x-gqts-requirement: REQ-GQTS-03
      description: |
        Returns metadata for one trust-service instance, including the current token-chain head state.
      parameters:
        - $ref: '#/components/parameters/ServiceId'
        - $ref: '#/components/parameters/IfNoneMatch'
      responses:
        '200':
          description: Service descriptor.
          headers:
            ETag:
              $ref: '#/components/headers/EntityTag'
            Cache-Control:
              $ref: '#/components/headers/CacheControl'
          content:
            application/gqts.type+json:
              schema:
                $ref: '#/components/schemas/ServiceDescriptor'
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceDescriptor'
        '304':
          description: Not modified.
        '400':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqts/event/{logId}:
    get:
      tags: [event]
      operationId: getEventLogView
      summary: Get event log head or event page.
      x-gqts-requirement: REQ-GQTS-05
      description: |
        Returns either a compact head-token view (default) or paged tokens for an append-only linear chain.
        Implementations SHOULD use conditional retrieval and compare `headTokenId` before expensive sync work.
      parameters:
        - $ref: '#/components/parameters/LogId'
        - $ref: '#/components/parameters/IfNoneMatch'
        - $ref: '#/components/parameters/View'
        - $ref: '#/components/parameters/FromTokenId'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Event log view.
          headers:
            ETag:
              $ref: '#/components/headers/EntityTag'
            Cache-Control:
              $ref: '#/components/headers/CacheControl'
          content:
            application/gqts.eventlog+json:
              schema:
                $ref: '#/components/schemas/EventLogView'
            application/json:
              schema:
                $ref: '#/components/schemas/EventLogView'
        '304':
          description: Not modified.
        '400':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'

    post:
      tags: [event]
      operationId: postEventIngest
      summary: Submit an event for ingest/gossip.
      x-gqts-requirement: REQ-GQTS-06
      description: |
        Accepts a signed history token for asynchronous processing.
        Successful acceptance returns `202 Accepted`; replication and merge-reconciliation outcomes are observed via GET event-log views.
      parameters:
        - $ref: '#/components/parameters/LogId'
      requestBody:
        required: true
        content:
          application/gqts.event+json:
            schema:
              $ref: '#/components/schemas/EventIngestRequest'
          application/json:
            schema:
              $ref: '#/components/schemas/EventIngestRequest'
      responses:
        '202':
          description: Accepted for asynchronous processing.
          content:
            application/gqts.ingest-receipt+json:
              schema:
                $ref: '#/components/schemas/AsyncReceipt'
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncReceipt'
        '400':
          $ref: '#/components/responses/Problem'
        '409':
          $ref: '#/components/responses/Problem'
        '413':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqts/event/{logId}/meta:
    get:
      tags: [event]
      operationId: getEventHeadMeta
      summary: Get compact token-chain head metadata.
      x-gqts-requirement: REQ-GQTS-04
      description: |
        Returns compact head-token metadata for opportunistic synchronization.
        Peers SHOULD compare this result before requesting token pages or merge-reconciliation processing.
      parameters:
        - $ref: '#/components/parameters/LogId'
        - $ref: '#/components/parameters/IfNoneMatch'
      responses:
        '200':
          description: Token-chain head metadata.
          headers:
            ETag:
              $ref: '#/components/headers/EntityTag'
            Cache-Control:
              $ref: '#/components/headers/CacheControl'
          content:
            application/gqts.event-head+json:
              schema:
                $ref: '#/components/schemas/EventHeadMeta'
            application/json:
              schema:
                $ref: '#/components/schemas/EventHeadMeta'
        '304':
          description: Not modified.
        '400':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'

  /.well-known/gidas/gqts/event/{logId}/{eventId}:
    get:
      tags: [event]
      operationId: getEventById
      summary: Get immutable history token.
      x-gqts-requirement: REQ-GQTS-07
      description: Retrieves one immutable signed history token by identifier.
      parameters:
        - $ref: '#/components/parameters/LogId'
        - $ref: '#/components/parameters/EventId'
      responses:
        '200':
          description: Event object.
          headers:
            ETag:
              $ref: '#/components/headers/EntityTag'
            Cache-Control:
              $ref: '#/components/headers/CacheControlImmutable'
          content:
            application/gqts.event+json:
              schema:
                $ref: '#/components/schemas/EventEnvelope'
            application/json:
              schema:
                $ref: '#/components/schemas/EventEnvelope'
        '400':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'

components:
  parameters:
    GovernanceCode:
      name: governanceCode
      in: path
      required: true
      description: |
        Lowercase ASCII governance identifier.
        Producers MUST normalize to lowercase before publication.
      schema:
        $ref: '#/components/schemas/GovernanceCode'

    ServiceId:
      name: serviceId
      in: path
      required: true
      description: Trust-service instance identifier.
      schema:
        $ref: '#/components/schemas/Identifier'

    LogId:
      name: logId
      in: path
      required: true
      description: Signed-token history namespace identifier.
      schema:
        $ref: '#/components/schemas/Identifier'

    EventId:
      name: eventId
      in: path
      required: true
      description: Immutable signed-token identifier.
      schema:
        $ref: '#/components/schemas/Identifier'

    IfNoneMatch:
      name: If-None-Match
      in: header
      required: false
      description: ETag validator for conditional retrieval.
      schema:
        type: string

    View:
      name: view
      in: query
      required: false
      description: Controls head-only versus paged-token retrieval.
      schema:
        type: string
        enum: [head, events]
        default: head

    FromTokenId:
      name: fromTokenId
      in: query
      required: false
      description: Resume cursor for paged token retrieval.
      schema:
        $ref: '#/components/schemas/Identifier'

    Limit:
      name: limit
      in: query
      required: false
      description: Page size for event retrieval.
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50

  headers:
    EntityTag:
      description: Entity tag representing current head token or immutable token object version.
      schema:
        type: string
    CacheControl:
      description: Cache policy for append-only token-chain views (typically short freshness with validators).
      schema:
        type: string
    CacheControlImmutable:
      description: Cache policy for immutable objects.
      schema:
        type: string

  responses:
    Problem:
      description: Error response with deterministic `code` semantics.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

  schemas:
    EndpointKind:
      type: string
      enum: [scheme, type, event]

    GovernanceCode:
      type: string
      pattern: '^[a-z0-9](?:[a-z0-9-]{0,62}[a-z0-9])?$'
      examples: [eu, fi-traficom, us-nist]

    Identifier:
      type: string
      minLength: 3
      maxLength: 128
      pattern: '^[A-Za-z0-9._:-]+$'
      examples: [a8bb9d18-c3bc-4f5b-9158-3ce0d48f4f8c, eu-qts-registry]

    UriDigest:
      type: object
      description: |
        Verification source reference. Legacy schema name retained for compatibility.
        Hash claims are not part of acceptance semantics in this profile.
      required: [uri, controller]
      additionalProperties: false
      properties:
        uri:
          type: string
          format: uri
        controller:
          type: string
          description: Entity/controller identifier that asserts the source material.

    SchemeDescriptor:
      type: object
      additionalProperties: false
      required:
        - kind
        - governanceCode
        - version
        - canonicalization
        - integrityModel
        - proofSuites
        - chainModel
        - endpointKinds
        - discovery
      properties:
        kind:
          type: string
          const: scheme
        governanceCode:
          $ref: '#/components/schemas/GovernanceCode'
        version:
          type: string
          examples: [v1]
        canonicalization:
          type: string
          description: Canonicalization profile for deterministic signed-token verification input.
          examples: [JCS]
        integrityModel:
          type: string
          const: signature-bound-content
          description: |
            Protocol acceptance MUST be based on signature/proof verification of canonicalized token content.
            Standalone content-hash claims MUST be ignored.
        chainModel:
          type: string
          enum: [directed-linear-signed-token-chain]
        proofSuites:
          type: array
          minItems: 1
          items:
            type: string
          examples:
            - [eddsa-jcs-2022, ecdsa-jcs-2019]
        endpointKinds:
          type: array
          minItems: 3
          uniqueItems: true
          examples:
            - [scheme, type, event]
          items:
            $ref: '#/components/schemas/EndpointKind'
        publicationFloor:
          type: array
          description: Optional governance minimum host targets.
          items:
            type: string
            format: uri
        endpointKindsRef:
          type: string
          format: uri-reference
          description: Relative or absolute URI to endpoint-kind catalog.
        discovery:
          type: object
          additionalProperties: false
          required: [schemeTemplate, typeTemplate, eventTemplate]
          properties:
            schemeTemplate:
              type: string
              examples: ['/.well-known/gidas/gqts/scheme/{governanceCode}']
            typeTemplate:
              type: string
              examples: ['/.well-known/gidas/gqts/type/{serviceId}']
            eventTemplate:
              type: string
              examples: ['/.well-known/gidas/gqts/event/{logId}']

    EndpointKindEntry:
      type: object
      additionalProperties: false
      required:
        - kind
        - purpose
        - pathTemplate
        - operationIds
        - primarySchema
        - consistencyModel
      properties:
        kind:
          $ref: '#/components/schemas/EndpointKind'
        purpose:
          type: string
        pathTemplate:
          type: string
          examples: ['/.well-known/gidas/gqts/{kind}/{id}']
        operationIds:
          type: array
          minItems: 1
          items:
            type: string
        primarySchema:
          type: string
          description: '#/components/schemas/... pointer.'
          examples: ['#/components/schemas/ServiceDescriptor']
        consistencyModel:
          type: string
          enum: [immutable, append-only, mutable-with-versioning]
        asyncIngestSupported:
          type: boolean
          default: false
      examples:
        - kind: event
          purpose: Append-only history publication and retrieval.
          pathTemplate: /.well-known/gidas/gqts/event/{logId}
          operationIds: [getEventHeadMeta, getEventLogView, postEventIngest, getEventById]
          primarySchema: '#/components/schemas/EventEnvelope'
          consistencyModel: append-only
          asyncIngestSupported: true

    EndpointKindCatalog:
      type: object
      additionalProperties: false
      required: [governanceCode, generatedAt, endpointKinds]
      properties:
        governanceCode:
          $ref: '#/components/schemas/GovernanceCode'
        generatedAt:
          type: string
          format: date-time
        endpointKinds:
          type: array
          minItems: 3
          items:
            $ref: '#/components/schemas/EndpointKindEntry'
      examples:
        - governanceCode: eu
          generatedAt: '2026-02-18T00:00:00Z'
          endpointKinds:
            - kind: scheme
              purpose: Governance profile metadata discovery.
              pathTemplate: /.well-known/gidas/gqts/scheme/{governanceCode}
              operationIds: [getSchemeDescriptor, getEndpointKindCatalog]
              primarySchema: '#/components/schemas/SchemeDescriptor'
              consistencyModel: mutable-with-versioning
            - kind: type
              purpose: Service descriptor publication.
              pathTemplate: /.well-known/gidas/gqts/type/{serviceId}
              operationIds: [getTypeDescriptor]
              primarySchema: '#/components/schemas/ServiceDescriptor'
              consistencyModel: mutable-with-versioning
            - kind: event
              purpose: Append-only event history operations.
              pathTemplate: /.well-known/gidas/gqts/event/{logId}
              operationIds: [getEventHeadMeta, getEventLogView, postEventIngest, getEventById]
              primarySchema: '#/components/schemas/EventEnvelope'
              consistencyModel: append-only
              asyncIngestSupported: true

    ServiceDescriptor:
      type: object
      additionalProperties: false
      required:
        - kind
        - serviceId
        - serviceType
        - governanceCode
        - eventLog
        - verificationSources
      properties:
        kind:
          type: string
          const: type
        serviceId:
          $ref: '#/components/schemas/Identifier'
        serviceType:
          type: string
          enum:
            - gdis-binding
            - gqtsp-evidence
            - trust-registry
            - pid-scheme
            - other
        governanceCode:
          $ref: '#/components/schemas/GovernanceCode'
        profileVersion:
          type: string
          examples: [v1]
        eventLog:
          type: object
          additionalProperties: false
          required: [logId, headTokenId, activeVerificationMethod]
          properties:
            logId:
              $ref: '#/components/schemas/Identifier'
            headTokenId:
              $ref: '#/components/schemas/Identifier'
            activeVerificationMethod:
              type: string
              description: Verification method identifier that MUST validate the current head token.
            reportEndpoint:
              type: string
              format: uri-reference
              description: Optional endpoint for invalid-token reporting when specified by active history tokens.
            gossipEndpoints:
              type: array
              description: Replication targets declared by the most recent valid token.
              items:
                type: string
                format: uri-reference
            updatedAt:
              type: string
              format: date-time
        verificationSources:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/UriDigest'

    EventLogView:
      type: object
      additionalProperties: false
      required: [kind, logId, view, headTokenId, activeVerificationMethod, events]
      properties:
        kind:
          type: string
          const: event
        logId:
          $ref: '#/components/schemas/Identifier'
        view:
          type: string
          enum: [head, events]
        headTokenId:
          $ref: '#/components/schemas/Identifier'
        activeVerificationMethod:
          type: string
        linearChain:
          type: boolean
          const: true
        events:
          type: array
          items:
            $ref: '#/components/schemas/EventEnvelope'
        nextFromTokenId:
          $ref: '#/components/schemas/Identifier'

    EventHeadMeta:
      type: object
      additionalProperties: false
      required: [kind, logId, headTokenId, activeVerificationMethod, eventCount, updatedAt]
      properties:
        kind:
          type: string
          const: event
        logId:
          $ref: '#/components/schemas/Identifier'
        headTokenId:
          $ref: '#/components/schemas/Identifier'
        activeVerificationMethod:
          type: string
        linearChain:
          type: boolean
          const: true
        eventCount:
          type: integer
          minimum: 0
        updatedAt:
          type: string
          format: date-time
        recommendedPollSeconds:
          type: integer
          minimum: 1

    EventEnvelope:
      type: object
      description: |
        Signed history token.
        Acceptance is determined by schema validity, directed linear chain-link validity, and proof verification.
        Standalone content-hash claims are ignored by protocol.
      additionalProperties: false
      required:
        - eventId
        - logId
        - sequence
        - createdAt
        - eventType
        - previousEventId
        - actorController
        - declaredVerificationMethod
        - payload
        - proofs
      properties:
        eventId:
          $ref: '#/components/schemas/Identifier'
        logId:
          $ref: '#/components/schemas/Identifier'
        sequence:
          type: integer
          minimum: 0
        createdAt:
          type: string
          format: date-time
        eventType:
          type: string
          enum: [genesis, publish, revoke, rotate, merge, report-config]
        previousEventId:
          oneOf:
            - $ref: '#/components/schemas/Identifier'
            - type: 'null'
          description: |
            Previous token pointer in the directed linear history.
            MUST be null only for the genesis token.
        actorController:
          type: string
          description: Entity/controller identifier whose intention is asserted by this token.
        delegatedIdentityContext:
          type: object
          additionalProperties: false
          properties:
            gdisSource:
              type: string
              format: uri-reference
            gqscdControllerDid:
              type: string
            pidDelegationReference:
              type: string
        declaredVerificationMethod:
          type: string
          description: Verification method that MUST validate this token signature.
        nextVerificationMethod:
          type: string
          description: |
            Next verification method activated by a rotate token.
            MUST be present for rotate tokens.
        mergedCandidateHeadEventIds:
          type: array
          description: Candidate heads reconciled by a merge token while keeping a single canonical previousEventId.
          minItems: 1
          items:
            $ref: '#/components/schemas/Identifier'
        gossipEndpoints:
          type: array
          description: Replication targets to which valid tokens SHOULD be gossiped.
          items:
            type: string
            format: uri-reference
        reportEndpoint:
          type: string
          format: uri-reference
          description: Optional endpoint for reporting invalid token candidates.
        blindVerificationMaterial:
          type: object
          additionalProperties: false
          properties:
            scheme:
              type: string
              enum: [oprf-blind, bbs-blind]
            materialReference:
              type: string
              format: uri-reference
            assertion:
              type: object
              additionalProperties: true
        payload:
          type: object
          additionalProperties: true
        proofs:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/Proof'
      allOf:
        - if:
            properties:
              eventType:
                const: genesis
          then:
            properties:
              previousEventId:
                type: 'null'
        - if:
            properties:
              eventType:
                const: rotate
          then:
            properties:
              nextVerificationMethod:
                type: string
            required: [nextVerificationMethod]

    Proof:
      type: object
      description: |
        Cryptographic proof object used for deterministic acceptance.
        Proof verification is the integrity primitive; separate hash claims are non-authoritative.
      additionalProperties: false
      required: [type, cryptosuite, verificationMethod, created, proofPurpose, proofValue]
      properties:
        type:
          type: string
          const: DataIntegrityProof
        cryptosuite:
          type: string
          examples: [eddsa-jcs-2022, ecdsa-jcs-2019]
        verificationMethod:
          type: string
        created:
          type: string
          format: date-time
        proofPurpose:
          type: string
          enum: [assertionMethod]
        proofValue:
          type: string

    ErrorCode:
      type: string
      enum:
        - ERR_SCHEMA_VALIDATION
        - ERR_CANONICALIZATION_FAILURE
        - ERR_TOKEN_CHAIN_LINK_INVALID
        - ERR_UNSUPPORTED_CRYPTOSUITE
        - ERR_PROOF_VERIFICATION_FAILED
        - ERR_ROTATION_CHAIN_INVALID
        - ERR_HISTORY_CONFLICT
        - ERR_POLICY_INPUT_UNAVAILABLE
        - ERR_POLICY_REJECTED

    EventIngestRequest:
      type: object
      additionalProperties: false
      required: [event]
      properties:
        event:
          $ref: '#/components/schemas/EventEnvelope'
        expectedHeadEventId:
          $ref: '#/components/schemas/Identifier'
        correlationId:
          type: string
          minLength: 8
          maxLength: 128

    AsyncReceipt:
      type: object
      additionalProperties: false
      required: [status, correlationId, logId, acceptedAt]
      properties:
        status:
          type: string
          const: accepted
        correlationId:
          type: string
        logId:
          $ref: '#/components/schemas/Identifier'
        acceptedAt:
          type: string
          format: date-time
        queuedEventId:
          $ref: '#/components/schemas/Identifier'

    ProblemDetails:
      type: object
      additionalProperties: true
      required: [type, title, status, code]
      properties:
        type:
          type: string
          format: uri-reference
        title:
          type: string
        status:
          type: integer
          minimum: 100
          maximum: 599
        code:
          $ref: '#/components/schemas/ErrorCode'
        detail:
          type: string
        instance:
          type: string
          format: uri-reference
